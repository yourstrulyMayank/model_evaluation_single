<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ model_name }} - Custom Evaluation Results</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #ffffff 0%, #e7e4eb 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .loading-container {
            text-align: center;
            padding: 3rem;
            color: white;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.2);
            border-top: 8px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-stage {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            border-left: 4px solid #28a745;
        }
        
        .stage-number {
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .results-container {
            color: white;
        }
        
        .metric-table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 2rem 0;
        }
        
        .metric-table table {
            margin: 0;
        }
        
        .metric-table th {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
            border: none;
            padding: 1rem;
        }
        
        .metric-table td {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            border: none;
            padding: 0.8rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .metric-table tr:last-child td {
            border-bottom: none;
        }
        
        .btn-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(116, 75, 162, 0.3);
        }
        
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(116, 75, 162, 0.4);
            color: white;
        }
        
        .btn-success-custom {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(40, 167, 69, 0.3);
        }
        
        .btn-success-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(40, 167, 69, 0.4);
            color: white;
        }
        
        .error-container {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 15px;
            padding: 2rem;
            color: #dc3545;
            text-align: center;
        }
        
        .header-section {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }
        
        .model-name {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .evaluation-type {
            font-size: 1.2rem;
            opacity: 0.9;
            text-transform: capitalize;
        }
        
        .action-buttons {
            text-align: center;
            margin: 2rem 0;
        }
        
        .action-buttons .btn {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="glass-card p-4">
                    <div class="header-section">
                        <h1 class="model-name">{{ model_name }}</h1>
                        <p class="evaluation-type">Custom RAG Evaluation Results</p>
                    </div>

                    <!-- Loading Screen -->
                    <div id="loadingScreen" class="loading-container" style="display: none;">
                        <div class="loading-spinner"></div>
                        <h3>Running Custom Evaluation...</h3>
                        <p id="loadingMessage">Initializing evaluation process...</p>
                        
                        <div id="progressStages" style="text-align: left; max-width: 600px; margin: 2rem auto;">
                            <div class="progress-stage" id="stage1" style="opacity: 0.3;">
                                <span class="stage-number">1</span>
                                <strong>Loading models and initializing...</strong>
                            </div>
                            <div class="progress-stage" id="stage2" style="opacity: 0.3;">
                                <span class="stage-number">2</span>
                                <strong>Processing files and creating vector database...</strong>
                            </div>
                            <div class="progress-stage" id="stage3" style="opacity: 0.3;">
                                <span class="stage-number">3</span>
                                <strong>Loading ground truth and running queries...</strong>
                            </div>
                            <div class="progress-stage" id="stage4" style="opacity: 0.3;">
                                <span class="stage-number">4</span>
                                <strong>Analyzing content and generating responses...</strong>
                            </div>
                            <div class="progress-stage" id="stage5" style="opacity: 0.3;">
                                <span class="stage-number">5</span>
                                <strong>Finalizing evaluation results...</strong>
                            </div>
                            <div class="progress-stage" id="stage6" style="opacity: 0.3;">
                                <span class="stage-number">6</span>
                                <strong>Evaluation completed successfully!</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Results Display -->
                    <div id="resultsContent" class="results-container">
                        {% if evaluation_results and not evaluation_results.get('error') %}
                            <!-- Results Summary Table -->
                            <div class="metric-table">
                                <table class="table table-borderless">
                                    <thead>
                                        <tr>
                                            <th style="width: 40%;">Metric</th>
                                            <th style="width: 60%;">Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Model Name</strong></td>
                                            <td>{{ evaluation_results.get('model_name', model_name) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Evaluation Type</strong></td>
                                            <td style="text-transform: capitalize;">{{ evaluation_results.get('evaluation_type', 'N/A') }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Evaluation Date</strong></td>
                                            <td>{{ evaluation_results.get('timestamp', 'N/A') }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Tests</strong></td>
                                            <td>{{ evaluation_results.get('total_tests', 0) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tests Passed</strong></td>
                                            <td>
                                                <span class="badge bg-success">{{ evaluation_results.get('pass_count', 0) }}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tests Failed</strong></td>
                                            <td>
                                                <span class="badge bg-danger">{{ evaluation_results.get('fail_count', 0) }}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Intermittent Tests</strong></td>
                                            <td>
                                                <span class="badge bg-warning">{{ evaluation_results.get('intermittent_count', 0) }}</span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Overall Score (%)</strong></td>
                                            <td>
                                                <strong style="font-size: 1.2em; color: #28a745;">
                                                    {{ "%.2f"|format(evaluation_results.get('overall_score', 0)) }}%
                                                </strong>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Success Rate (%)</strong></td>
                                            <td>{{ "%.2f"|format(evaluation_results.get('success_rate', 0)) }}%</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Average Score</strong></td>
                                            <td>{{ "%.2f"|format(evaluation_results.get('average_score', 0)) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Highest Score</strong></td>
                                            <td>{{ "%.2f"|format(evaluation_results.get('summary_statistics', {}).get('highest_score', 0)) }}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Lowest Score</strong></td>
                                            <td>{{ "%.2f"|format(evaluation_results.get('summary_statistics', {}).get('lowest_score', 0)) }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        {% elif evaluation_results and evaluation_results.get('error') %}
                            <!-- Error Display -->
                            <div class="error-container">
                                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                                <h4>Evaluation Error</h4>
                                <p>{{ evaluation_results.get('error', 'Unknown error occurred') }}</p>
                                {% if evaluation_results.get('traceback') %}
                                    <details class="mt-3">
                                        <summary>Technical Details</summary>
                                        <pre class="text-start mt-2" style="font-size: 0.8em;">{{ evaluation_results.get('traceback') }}</pre>
                                    </details>
                                {% endif %}
                            </div>

                        {% else %}
                            <!-- No Results -->
                            <div class="text-center text-white">
                                <i class="fas fa-chart-line fa-4x mb-4" style="opacity: 0.5;"></i>
                                <h4>No Evaluation Results</h4>
                                <p>Click "Start Evaluation" to begin the custom RAG evaluation process.</p>
                            </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-custom" onclick="startEvaluation()">
                                <i class="fas fa-play me-2"></i>Start Evaluation
                            </button>
                            
                            {% if evaluation_results and not evaluation_results.get('error') %}
                                <a href="{{ url_for('download_custom_excel', model_name=model_name) }}" 
                                   class="btn btn-success-custom">
                                    <i class="fas fa-download me-2"></i>Download Excel Report
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        let checkStatusInterval;
        const modelName = "{{ model_name }}";

        function startEvaluation() {
            // Show loading screen
            document.getElementById('loadingScreen').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            
            // Reset progress stages
            resetProgressStages();
            
            // Start evaluation
            fetch(`/run_custom_evaluation/${modelName}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'started') {
                    // Start checking status
                    checkStatusInterval = setInterval(checkEvaluationStatus, 2000);
                } else {
                    throw new Error(data.error || 'Failed to start evaluation');
                }
            })
            .catch(error => {
                console.error('Error starting evaluation:', error);
                alert('Error starting evaluation: ' + error.message);
                hideLoadingScreen();
            });
        }

        function checkEvaluationStatus() {
            fetch(`/check_custom_status/${modelName}`)
                .then(response => response.json())
                .then(data => {
                    updateLoadingProgress(data);
                    
                    if (data.status === 'complete') {
                        clearInterval(checkStatusInterval);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else if (data.status === 'error') {
                        clearInterval(checkStatusInterval);
                        alert('Evaluation failed: ' + (data.results.error || 'Unknown error'));
                        hideLoadingScreen();
                    }
                })
                .catch(error => {
                    console.error('Error checking status:', error);
                });
        }

        function updateLoadingProgress(data) {
            const progress = data.progress || {};
            const stage = progress.stage || 0;
            const message = progress.message || 'Processing...';
            
            // Update loading message
            document.getElementById('loadingMessage').textContent = message;
            
            // Update progress stages
            for (let i = 1; i <= 6; i++) {
                const stageElement = document.getElementById(`stage${i}`);
                if (i <= stage) {
                    stageElement.style.opacity = '1';
                    stageElement.style.borderLeftColor = '#28a745';
                } else {
                    stageElement.style.opacity = '0.3';
                    stageElement.style.borderLeftColor = 'rgba(255, 255, 255, 0.2)';
                }
            }
        }

        function resetProgressStages() {
            for (let i = 1; i <= 6; i++) {
                const stageElement = document.getElementById(`stage${i}`);
                stageElement.style.opacity = '0.3';
                stageElement.style.borderLeftColor = 'rgba(255, 255, 255, 0.2)';
            }
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('resultsContent').style.display = 'block';
        }

        // Check if evaluation is already running when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetch(`/check_custom_status/${modelName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'processing') {
                        document.getElementById('loadingScreen').style.display = 'block';
                        document.getElementById('resultsContent').style.display = 'none';
                        checkStatusInterval = setInterval(checkEvaluationStatus, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error checking initial status:', error);
                });
        });
    </script>
</body>
</html>